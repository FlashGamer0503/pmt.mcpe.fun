{"changed":true,"filter":false,"title":"convert.php","tooltip":"/pages/phar2zip/convert.php","value":"<?php\n\nini_set(\"display_errors\", -1);\n\nglobal $ROOT_DIR;\n$ROOT_DIR = implode(DIRECTORY_SEPARATOR, array_slice(explode(DIRECTORY_SEPARATOR, __DIR__), 0, count(explode(DIRECTORY_SEPARATOR, __DIR__)) - 2));\n\ntry {\n   \n    // Undefined | Multiple Files | $_FILES Corruption Attack\n    if (\n        !isset($_FILES['upfile']['error']) ||\n        is_array($_FILES['upfile']['error'])\n    ) {\n        throw new RuntimeException('Invalid parameters.');\n    }\n\n    // Check $_FILES['upfile']['error'] value.\n    switch ($_FILES['upfile']['error']) {\n        case UPLOAD_ERR_OK:\n            break;\n        case UPLOAD_ERR_NO_FILE:\n            throw new RuntimeException('No file sent.');\n        case UPLOAD_ERR_INI_SIZE:\n        case UPLOAD_ERR_FORM_SIZE:\n            throw new RuntimeException('Exceeded filesize limit.');\n        default:\n            throw new RuntimeException('Unknown errors.');\n    }\n\n    // You should also check filesize here.\n    if ($_FILES['upfile']['size'] > 100000000) {\n        throw new RuntimeException('Exceeded filesize limit.');\n    }\n\n    // DO NOT TRUST $_FILES['upfile']['mime'] VALUE !!\n    // Check MIME Type by yourself.\n    $finfo = new finfo(FILEINFO_MIME_TYPE);\n    if (false === $ext = array_search(\n        $finfo->file($_FILES['upfile']['tmp_name']),\n        array(\n            'phar' => \"application/octet-stream\",\n        ),\n        true\n    )) {\n        throw new RuntimeException('Invalid file format.');\n    }\n\n    $fName = \"phar_\" . sha1_file($_FILES['upfile']['tmp_name']);\n\n    // Moving PHAR file.\n    if (!move_uploaded_file(\n        $_FILES['upfile']['tmp_name'],\n        \"$ROOT_DIR/data/tmp/$fName.phar\"\n    )) {\n        throw new RuntimeException('Failed to move uploaded file.');\n    }\n    $phar = new Phar(\"$ROOT_DIR/data/tmp/$fName.phar\");\n    $phar->extractTo(\"$ROOT_DIR/data/tmp/$fName\");\n    $plData = @yaml_parse_file(\"$ROOT_DIR/data/tmp/$fName/plugin.yml\");\n    if($plData == false) $plData = [\"name\" => \"Unknown\", \"author\" => \"Unknown\", \"api\" => \"3.0.0\", \"version\" => 1.0];\n    unlink(\"$ROOT_DIR/data/tmp/$fName.phar\");\n\n    // Building zip\n    global $zipFileName;\n    $zipFileName = \"zip_\" . $plData[\"name\"] . \"_\" . sha1(sha1_file($ROOT_DIR . \"/data/tmp/$fName\") . sha1(time()));\n    $zip = new ZipArchive();\n    if(file_exists($ROOT_DIR . \"/data/phars/$zipFileName.zip\")) unlink($ROOT_DIR . \"/data/phars/$zipFileName.zip\"); // Should only rarely happend\n    $zip->open($ROOT_DIR . \"/data/phars/$zipFileName.zip\", ZIPARCHIVE::CREATE);\n    $files = new RecursiveIteratorIterator(\n        new RecursiveDirectoryIterator(\"$ROOT_DIR/data/tmp/$fName\"),\n        RecursiveIteratorIterator::LEAVES_ONLY\n    );\n    // Adding files\n    foreach ($files as $name => $file) {\n        if (!$file->isDir()) {\n            $filePath = $file->getRealPath();\n            $relativePath = substr($filePath, strlen(\"$ROOT_DIR/data/tmp/$fName\") + 1);\n            $zip->addFile($filePath, $relativePath);\n        }\n    }\n    $zip->close();\n    chmod($ROOT_DIR . \"/data/phars/$zipFileName.zip\", 0777);\n} catch(Exception $e) {\n    $error = $e->getMessage();\n}\nif(isset($fName)) exec(\"rm -rf $ROOT_DIR/data/tmp/$fName\");\n?>\n\n<html>\n\n<head>\n    <link href=\"https://fonts.googleapis.com/css?family=Roboto:regular,bold,italic,thin,light,bolditalic,black,medium&amp;lang=en\" rel=\"stylesheet\">\n    <link href=\"https://fonts.googleapis.com/icon?family=Material+Icons\" rel=\"stylesheet\">\n    <link href=\"https://code.getmdl.io/1.3.0/material.cyan-light_blue.min.css\" rel=\"stylesheet\">\n    <script defer src=\"https://code.getmdl.io/1.3.0/material.min.js\">\n    </script>\n    <link href=\"https://archive.org/download/material-design-style-css/styles.css\" rel=\"stylesheet\">\n    <link href=\"/css/main.css\" rel=\"stylesheet\">\n    <title>PMT - PocketMine Tools</title>\n</head>\n\n<body>\n    <h2><?php echo !isset($error) ? \"<h3>Successfully Created!</h3><br><p>Your file was successfully converted. You should now be able to use your plugin in \\\"PocketMine-MP\\\"<br><strong>Corrupted Plugin? Send the file over twitter and we will track down the issue!</strong></p>\" : \"<h3>Could not build zip: $error</h3>\"; ?></h2>\n        <?php if(!isset($error)) echo '<a href=\"download.php?n=' . $zipFileName . '\"><button class=\"mdl-button mdl-js-button mdl-js-ripple-effect\">Download</button></a>'; ?>\n        <a href=\"index.html\"><button class=\"mdl-button mdl-js-button mdl-js-ripple-effect\">Go back</button></a>\n    </p>\n</body>\n</html>","undoManager":{"mark":-2,"position":42,"stack":[[{"start":{"row":103,"column":37},"end":{"row":103,"column":59},"action":"remove","lines":["Download extracted zip"],"id":2},{"start":{"row":103,"column":37},"end":{"row":103,"column":284},"action":"insert","lines":["<h3>Update Complete!</h3><br><p>Your file was successfully converted. You should now be able to use your plugin in \\\"PocketMine-MP\\\"<br><strong>Corrupted Plugin? Send the file over using our live chat and we will track down the issue!</strong></p>"]}],[{"start":{"row":103,"column":41},"end":{"row":103,"column":56},"action":"remove","lines":["Update Complete"],"id":3},{"start":{"row":103,"column":41},"end":{"row":103,"column":42},"action":"insert","lines":["S"]}],[{"start":{"row":103,"column":42},"end":{"row":103,"column":43},"action":"insert","lines":["u"],"id":4}],[{"start":{"row":103,"column":43},"end":{"row":103,"column":44},"action":"insert","lines":["c"],"id":5}],[{"start":{"row":103,"column":44},"end":{"row":103,"column":45},"action":"insert","lines":["c"],"id":6}],[{"start":{"row":103,"column":45},"end":{"row":103,"column":46},"action":"insert","lines":["e"],"id":7}],[{"start":{"row":103,"column":46},"end":{"row":103,"column":47},"action":"insert","lines":["s"],"id":8}],[{"start":{"row":103,"column":47},"end":{"row":103,"column":48},"action":"insert","lines":["s"],"id":9}],[{"start":{"row":103,"column":48},"end":{"row":103,"column":49},"action":"insert","lines":["f"],"id":10}],[{"start":{"row":103,"column":49},"end":{"row":103,"column":50},"action":"insert","lines":["u"],"id":11}],[{"start":{"row":103,"column":50},"end":{"row":103,"column":51},"action":"insert","lines":["l"],"id":12}],[{"start":{"row":103,"column":51},"end":{"row":103,"column":52},"action":"insert","lines":["l"],"id":13}],[{"start":{"row":103,"column":52},"end":{"row":103,"column":53},"action":"insert","lines":["y"],"id":14}],[{"start":{"row":103,"column":53},"end":{"row":103,"column":54},"action":"insert","lines":[" "],"id":15}],[{"start":{"row":103,"column":54},"end":{"row":103,"column":55},"action":"insert","lines":["C"],"id":16}],[{"start":{"row":103,"column":55},"end":{"row":103,"column":56},"action":"insert","lines":["r"],"id":17}],[{"start":{"row":103,"column":56},"end":{"row":103,"column":57},"action":"insert","lines":["e"],"id":18}],[{"start":{"row":103,"column":57},"end":{"row":103,"column":58},"action":"insert","lines":["a"],"id":19}],[{"start":{"row":103,"column":58},"end":{"row":103,"column":59},"action":"insert","lines":["t"],"id":20}],[{"start":{"row":103,"column":59},"end":{"row":103,"column":60},"action":"insert","lines":["e"],"id":21}],[{"start":{"row":103,"column":60},"end":{"row":103,"column":61},"action":"insert","lines":["d"],"id":22}],[{"start":{"row":103,"column":223},"end":{"row":103,"column":242},"action":"remove","lines":["using our live chat"],"id":23},{"start":{"row":103,"column":223},"end":{"row":103,"column":224},"action":"insert","lines":["t"]}],[{"start":{"row":103,"column":224},"end":{"row":103,"column":225},"action":"insert","lines":["w"],"id":24}],[{"start":{"row":103,"column":225},"end":{"row":103,"column":226},"action":"insert","lines":["i"],"id":25}],[{"start":{"row":103,"column":226},"end":{"row":103,"column":227},"action":"insert","lines":["t"],"id":26}],[{"start":{"row":103,"column":227},"end":{"row":103,"column":228},"action":"insert","lines":["t"],"id":27}],[{"start":{"row":103,"column":228},"end":{"row":103,"column":229},"action":"insert","lines":["e"],"id":28}],[{"start":{"row":103,"column":229},"end":{"row":103,"column":230},"action":"insert","lines":["r"],"id":29}],[{"start":{"row":103,"column":282},"end":{"row":103,"column":283},"action":"insert","lines":["<"],"id":30}],[{"start":{"row":103,"column":283},"end":{"row":103,"column":284},"action":"insert","lines":["h"],"id":31}],[{"start":{"row":103,"column":284},"end":{"row":103,"column":285},"action":"insert","lines":["3"],"id":32}],[{"start":{"row":103,"column":284},"end":{"row":103,"column":285},"action":"remove","lines":["3"],"id":33}],[{"start":{"row":103,"column":284},"end":{"row":103,"column":285},"action":"insert","lines":["2"],"id":34}],[{"start":{"row":103,"column":284},"end":{"row":103,"column":285},"action":"remove","lines":["2"],"id":35}],[{"start":{"row":103,"column":284},"end":{"row":103,"column":285},"action":"insert","lines":["4"],"id":36}],[{"start":{"row":103,"column":284},"end":{"row":103,"column":285},"action":"remove","lines":["4"],"id":37}],[{"start":{"row":103,"column":284},"end":{"row":103,"column":285},"action":"insert","lines":["3"],"id":38}],[{"start":{"row":103,"column":285},"end":{"row":103,"column":286},"action":"insert","lines":[">"],"id":39}],[{"start":{"row":103,"column":313},"end":{"row":103,"column":314},"action":"insert","lines":["<"],"id":40}],[{"start":{"row":103,"column":314},"end":{"row":103,"column":315},"action":"insert","lines":["h"],"id":41}],[{"start":{"row":103,"column":315},"end":{"row":103,"column":316},"action":"insert","lines":["3"],"id":42}],[{"start":{"row":103,"column":316},"end":{"row":103,"column":317},"action":"insert","lines":[">"],"id":43}],[{"start":{"row":103,"column":314},"end":{"row":103,"column":315},"action":"insert","lines":["/"],"id":44}]]},"ace":{"folds":[],"scrolltop":1336.5,"scrollleft":1145.4215625,"selection":{"start":{"row":103,"column":282},"end":{"row":103,"column":318},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":153,"mode":"ace/mode/php"}},"timestamp":1497124486948}